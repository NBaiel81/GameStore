<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Page</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #f8f8f8; border-bottom: 1px solid #ddd; }
        .navbar img { height: 40px; }
        .navbar .icons { display: flex; gap: 15px; align-items: center; }
        .search-container { position: relative; }
        .search-container input { padding: 5px; width: 200px; }
        .search-results { position: absolute; top: 100%; left: 0; width: 200px; background: white; border: none; max-height: 200px; overflow-y: auto; display: none; z-index: 10; }
        .search-results div { padding: 5px; cursor: pointer; }
        .search-results div:hover { background: #f0f0f0; }
        .search-results .no-matches { color: #888; cursor: default; }
        .search-results .no-matches:hover { background: none; }
        .container { display: flex; min-height: calc(100vh - 60px); }
        .sidebar { width: 250px; padding: 20px; background: #f0f0f0; position: fixed; height: 100%; overflow-y: auto; }
        .sidebar h3 { font-size: 18px; margin-bottom: 10px; }
        .sidebar h4 { font-size: 16px; margin: 10px 0 5px; }
        .sidebar label { display: block; margin: 5px 0; }
        .content { margin-left: 270px; padding: 20px; flex-grow: 1; }
        .sort-by { display: flex; justify-content: flex-end; margin-bottom: 20px; }
        .sort-by select { padding: 5px; }
        .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .game-card { border: 1px solid #ddd; padding: 10px; text-align: center; position: relative; background: #fff; }
        .game-card img { width: 100%; height: 150px; object-fit: cover; }
        .game-card h4 { font-size: 16px; margin: 10px 0 5px; }
        .game-card p { margin: 5px 0; }
        .wishlist-star { position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 20px; }
        .wishlist-star.active { color: gold; text-shadow: 0 0 5px gold; }
        .price { font-weight: bold; }
        .discount { color: red; font-size: 14px; }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="index.html">
            <img src="logo.png" alt="Logo">
        </a>
        <div class="icons">
            <div class="search-container">
                <input type="text" id="search-bar" placeholder="Search games...">
                <div class="search-results" id="search-results"></div>
            </div>
            <span>ðŸ””</span>
            <span>ðŸ‘¤</span>
        </div>
    </div>
    <div class="container">
        <div class="sidebar">
            <h3>FILTERS</h3>
            <div>
                <h4>Categories</h4>
                <label><input type="checkbox" class="filter-category" value="Bundles"> Bundles</label>
                <label><input type="checkbox" class="filter-category" value="Games"> Games</label>
                <label><input type="checkbox" class="filter-category" value="On Sale"> On Sale</label>
            </div>
            <div>
                <h4>Price</h4>
                <label><input type="checkbox" class="filter-price" value="u10"> Under $10</label>
                <label><input type="checkbox" class="filter-price" value="u20"> Under $20</label>
                <label><input type="checkbox" class="filter-price" value="u30"> Under $30</label>
                <label><input type="checkbox" class="filter-price" value="u40"> Under $40</label>
            </div>
            <div>
                <h4>Genres</h4>
                <label><input type="checkbox" class="filter-genre" value="Horror"> Horror</label>
                <label><input type="checkbox" class="filter-genre" value="RPG"> RPG</label>
                <label><input type="checkbox" class="filter-genre" value="Strategy"> Strategy</label>
                <label><input type="checkbox" class="filter-genre" value="FPS"> FPS</label>
            </div>
            <div>
                <h4>Platforms</h4>
                <label><input type="checkbox" class="filter-platform" value="Mac"> Mac</label>
                <label><input type="checkbox" class="filter-platform" value="Windows"> Windows</label>
                <label><input type="checkbox" class="filter-platform" value="Nintendo"> Nintendo</label>
                <label><input type="checkbox" class="filter-platform" value="PlayStation"> PlayStation</label>
                <label><input type="checkbox" class="filter-platform" value="Xbox"> Xbox</label>
            </div>
        </div>
        <div class="content">
            <div class="sort-by">
                <select id="sort-select">
                    <option value="topDiscount">Top Discount</option>
                    <option value="alphabetical">Alphabetical</option>
                    <option value="bestSeller">Best Seller</option>
                    <option value="newItems">New Items First</option>
                    <option value="bestRating">Best Rating First</option>
                </select>
            </div>
            <div class="game-grid" id="game-grid"></div>
        </div>
    </div>
    <script type="module">
        import { data } from './data.js';

        const searchBar = document.getElementById('search-bar');
        const searchResults = document.getElementById('search-results');
        const gameGrid = document.getElementById('game-grid');
        const sortSelect = document.getElementById('sort-select');
        const filterCategories = document.querySelectorAll('.filter-category');
        const filterPrices = document.querySelectorAll('.filter-price');
        const filterGenres = document.querySelectorAll('.filter-genre');
        const filterPlatforms = document.querySelectorAll('.filter-platform');

        // Search bar functionality
        searchBar.addEventListener('input', () => {
            const query = searchBar.value.toLowerCase();
            searchResults.innerHTML = '';
            searchResults.style.display = 'none';

            if (query) {
                const matches = data.games.filter(game => game.name.toLowerCase().includes(query));
                if (matches.length > 0) {
                    matches.forEach(game => {
                        const result = document.createElement('div');
                        result.textContent = game.name;
                        result.addEventListener('click', () => {
                            window.location.href = `game.html?id=${game.id}`;
                        });
                        searchResults.appendChild(result);
                    });
                    searchResults.style.display = 'block';
                } else {
                    const noMatches = document.createElement('div');
                    noMatches.className = 'no-matches';
                    noMatches.textContent = 'No matches';
                    searchResults.appendChild(noMatches);
                    searchResults.style.display = 'block';
                }
            }
        });

        searchBar.addEventListener('blur', () => {
            setTimeout(() => {
                searchResults.style.display = 'none';
            }, 200);
        });

        searchBar.addEventListener('focus', () => {
            if (searchBar.value) {
                searchResults.style.display = 'block';
            }
        });

        // Make price checkboxes mutually exclusive
        filterPrices.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    filterPrices.forEach(cb => {
                        if (cb !== checkbox) cb.checked = false;
                    });
                }
                renderItems();
            });
        });

        // Parse URL parameters to pre-apply filters
        const urlParams = new URLSearchParams(window.location.search);
        const categories = urlParams.getAll('category');
        const excludeCategories = urlParams.getAll('exclude');
        const price = urlParams.get('price');
        const genres = urlParams.getAll('genre');
        const platforms = urlParams.getAll('platform');
        const sortBy = urlParams.get('sort');

        // Apply initial filters from URL
        filterCategories.forEach(cb => {
            cb.checked = false;
            if (categories.includes(cb.value)) cb.checked = true;
            if (excludeCategories.includes(cb.value)) cb.checked = false;
        });

        filterPrices.forEach(cb => {
            cb.checked = false;
            if (price === cb.value) cb.checked = true;
        });

        filterGenres.forEach(cb => {
            cb.checked = false;
            if (genres.includes(cb.value)) cb.checked = true;
        });

        filterPlatforms.forEach(cb => {
            cb.checked = false;
            if (platforms.includes(cb.value)) cb.checked = true;
        });

        if (sortBy) sortSelect.value = sortBy;

        function getFilteredItems() {
            const selectedCategories = Array.from(filterCategories).filter(cb => cb.checked).map(cb => cb.value);
            const selectedPrices = Array.from(filterPrices).filter(cb => cb.checked).map(cb => cb.value);
            const selectedGenres = Array.from(filterGenres).filter(cb => cb.checked).map(cb => cb.value);
            const selectedPlatforms = Array.from(filterPlatforms).filter(cb => cb.checked).map(cb => cb.value);

            // Start with all items
            let items = [...data.games, ...data.bundles];

            // Apply "Games" and "Bundles" filters if selected
            const hasGamesFilter = selectedCategories.includes('Games');
            const hasBundlesFilter = selectedCategories.includes('Bundles');
            if (hasGamesFilter || hasBundlesFilter) {
                items = items.filter(item => 
                    (hasGamesFilter && !item.isBundle) || (hasBundlesFilter && item.isBundle)
                );
            }

            // Apply "On Sale" filter if selected
            if (selectedCategories.includes('On Sale')) {
                items = items.filter(item => item.isSale);
            }

            // Apply additional filters
            return items.filter(item => {
                const price = item.isBundle ? item.basePrice : item.price;
                const discountedPrice = item.discount ? price * (1 - item.discount / 100) : price;

                // Apply price filter
                const matchesPrice = selectedPrices.length === 0 || selectedPrices.some(range => {
                    if (range === 'u10') return discountedPrice < 10;
                    if (range === 'u20') return discountedPrice < 20;
                    if (range === 'u30') return discountedPrice < 30;
                    if (range === 'u40') return discountedPrice < 40;
                    return true;
                });

                // Apply genre filter
                const matchesGenre = selectedGenres.length === 0 || selectedGenres.includes(item.genre);

                // Apply platform filter
                const matchesPlatform = selectedPlatforms.length === 0 || selectedPlatforms.some(p => {
                    if (p === 'Windows') return item.platform === 'PC' || item.platform === 'Web';
                    if (p === 'Nintendo') return item.platform === 'Switch';
                    if (p === 'PlayStation') return item.platform === 'PS';
                    return item.platform === p;
                });

                return matchesPrice && matchesGenre && matchesPlatform;
            });
        }

        function sortItems(items) {
            const sortBy = sortSelect.value;
            return items.sort((a, b) => {
                if (sortBy === 'alphabetical') return a.name.localeCompare(b.name);
                if (sortBy === 'bestSeller') return (b.bestSelling ? 1 : 0) - (a.bestSelling ? 1 : 0);
                if (sortBy === 'topDiscount') return (b.discount || 0) - (a.discount || 0);
                if (sortBy === 'newItems') return (b.isNew ? 1 : 0) - (a.isNew ? 1 : 0);
                if (sortBy === 'bestRating') return b.rating - a.rating;
                return 0;
            });
        }

        function renderItems() {
            const filteredItems = getFilteredItems();
            const sortedItems = sortItems(filteredItems);
            gameGrid.innerHTML = '';

            sortedItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'game-card';
                const price = item.isBundle ? item.basePrice : item.price;
                const discountedPrice = item.discount ? price * (1 - item.discount / 100) : price;
                const href = item.isBundle ? `bundle.html?id=${item.id}` : `game.html?id=${item.id}`;
                const gameCount = item.isBundle ? item.tiers[item.tiers.length - 1].gamesIncluded.length : null;
                card.innerHTML = `
                    <a href="${href}">
                        <img src="${item.images[0]}" alt="${item.name}">
                        <h4>${item.name}</h4>
                        <p class="platform">${item.platform}${item.isBundle ? ` (${gameCount} games)` : ''}</p>
                        <p class="price">$${discountedPrice.toFixed(2)}${item.discount ? `<span class="discount"> (was $${price})</span>` : ''}</p>
                    </a>
                    <span class="wishlist-star ${item.wishlist ? 'active' : ''}">â˜…</span>
                `;
                const star = card.querySelector('.wishlist-star');
                star.addEventListener('click', () => star.classList.toggle('active'));
                gameGrid.appendChild(card);
            });
        }

        filterCategories.forEach(cb => cb.addEventListener('change', renderItems));
        filterPrices.forEach(cb => cb.addEventListener('change', renderItems));
        filterGenres.forEach(cb => cb.addEventListener('change', renderItems));
        filterPlatforms.forEach(cb => cb.addEventListener('change', renderItems));
        sortSelect.addEventListener('change', renderItems);

        renderItems();
    </script>
</body>
</html>